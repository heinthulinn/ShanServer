// ===== payout.js =====

/**
 * Collects bets from players at the start of the round.
 * Banker (Dealer) is excluded from paying a bet.
 */
function collectBets(players) {
  players.forEach(p => {
    // BANKER FIX: The dealer does not place a bet.
    if (p.isDealer) {
      p.currentBet = 0;
      return;
    }

    p.currentBet = Number(p.currentBet) || 0;
    if (p.balance >= p.currentBet) {
      p.balance -= p.currentBet;
    } else {
      // If player is short on cash, they go All-In
      p.currentBet = p.balance;
      p.balance = 0;
    }
  });
}

/**
 * Payout winners and losers
 * Banker pays winners and collects from losers.
 * @param {Array} players - all table players
 * @param {Array} winners - array of winner usernames
 */
/**
 * Payout winners and losers
 * Banker pays winners and collects from losers using the locked bankerFund.
 */
function payoutWinners(players, winners) {
  const dealer = players.find(p => p.isDealer);
  if (!dealer) {
    console.warn("âš ï¸ No dealer found! Cannot payout.");
    return [];
  }

  // 1. Recover the locked 10X fund we took in startGame.js
  const initialFund = dealer.bankerFund || 0;
  const winnerNames = new Set(winners);
  const results = []; 
  let dealerDelta = 0; 

  players.forEach(p => {
    if (p.isDealer || p.waiting) return;

    const bet = p.currentBet || 0;
    if (bet <= 0) return;

    const multiplier = p.multiplier || 1; 
    const totalStake = bet * multiplier;
    let delta = 0;

    if (winnerNames.has(p.username)) {
      // PLAYER WINS: Banker loses money
      delta = totalStake; 
      p.balance += (bet + delta); 
      dealerDelta -= delta;
      console.log(`ðŸ’µ WIN â†’ ${p.username} | Bet:${bet} | x${multiplier} | Dealer pays:${delta}`);
    } else {
      // PLAYER LOSES: Banker gains money
      delta = -totalStake;
      const extraLoss = totalStake - bet;
      p.balance -= extraLoss; 
      dealerDelta += totalStake;
      console.log(`âŒ LOSE â†’ ${p.username} | Bet:${bet} | x${multiplier} | Player pays:${totalStake}`);
    }

    results.push({
      username: p.username,
      delta: delta,
      balance: p.balance,
      multiplier: multiplier,
      isDealer: false
    });
  });

  // 2. FINAL BANKER SETTLEMENT
  // We return the original 10X Fund + the total profit/loss (dealerDelta)
  dealer.balance += (initialFund + dealerDelta);
  
  // 3. Reset the fund for the next round
  dealer.bankerFund = 0;

  results.push({
    username: dealer.username,
    delta: dealerDelta,
    balance: dealer.balance,
    multiplier: 1,
    isDealer: true
  });

  console.log(`ðŸƒ Banker (${dealer.username}) | Fund Returned: ${initialFund} | Profit/Loss: ${dealerDelta} | New Balance: ${dealer.balance}`);
  
  return results; 
}

module.exports = {
  collectBets,
  payoutWinners
};