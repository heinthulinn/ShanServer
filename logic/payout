// ===== payout.js =====

/**
 * Collects bets from players at the start of the round.
 * Banker (Dealer) is excluded from paying a bet.
 */
function collectBets(players) {
  players.forEach(p => {
    // BANKER FIX: The dealer does not place a bet.
    if (p.isDealer) {
      p.currentBet = 0;
      return;
    }

    p.currentBet = Number(p.currentBet) || 0;

    if (p.balance >= p.currentBet) {
      p.balance -= p.currentBet;
    } else {
      // All-in
      p.currentBet = p.balance;
      p.balance = 0;
    }
  });
}

/**
 * Payout winners and losers
 * Banker pays winners and collects from losers using the locked bankerFund.
 */
function payoutWinners(table, players, winners) {
  const dealer = players.find(p => p.isDealer);
  if (!dealer) {
    console.warn("‚ö†Ô∏è No dealer found! Cannot payout.");
    return [];
  }

  // Locked 10x fund from dealer assignment
  const initialFund = dealer.bankerFund || 0;
  const winnerNames = new Set(winners);
  const results = [];
  let dealerDelta = 0;

  players.forEach(p => {
    if (p.isDealer || p.waiting) return;

    const bet = p.currentBet || 0;
    if (bet <= 0) return;

    const multiplier = p.multiplier || 1;
    const totalStake = bet * multiplier;
    let delta = 0;

    if (winnerNames.has(p.username)) {
      // PLAYER WINS ‚Üí dealer pays profit
      delta = totalStake;
      p.balance += (bet + delta);
      dealerDelta -= delta;

      console.log(
        `üíµ WIN ‚Üí ${p.username} | Bet:${bet} | x${multiplier} | Dealer pays:${delta}`
      );
    } else {
      // PLAYER LOSES ‚Üí dealer collects
      delta = -totalStake;

      // Bet already deducted in collectBets()
      const lossExtra = totalStake - bet;
      if (lossExtra > 0) {
        p.balance -= lossExtra;
      }

      dealerDelta += totalStake;

      console.log(
        `‚ùå LOSE ‚Üí ${p.username} | Bet:${bet} | x${multiplier} | Player pays:${totalStake}`
      );
    }

    results.push({
      username: p.username,
      delta: delta,
      balance: p.balance,
      multiplier: multiplier,
      isDealer: false
    });
  });

  // ===== FINAL BANKER SETTLEMENT =====

  // Apply profit / loss to dealer real balance
  dealer.balance += dealerDelta;

  // Safety init
  if (typeof table.bankerPot !== "number") {
    table.bankerPot = 0;
  }

  // Update session banker pot
  table.bankerPot += dealerDelta;
  if (table.bankerPot < 0) table.bankerPot = 0;

  // Reset locked fund for next round
  dealer.bankerFund = 0;

  results.push({
    username: dealer.username,
    delta: dealerDelta,
    balance: dealer.balance,
    bankerPot: table.bankerPot,
    multiplier: 1,
    isDealer: true
  });

  console.log(
    `üÉè Banker (${dealer.username}) | Fund:${initialFund} | P/L:${dealerDelta} | New Balance:${dealer.balance}`
  );

  return results;
}

module.exports = {
  collectBets,
  payoutWinners
};
