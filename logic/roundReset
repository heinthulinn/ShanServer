//====== roundReset.js ======

function resetPlayersForNextRound(table) {
  table.players.forEach(p => {
    // ğŸ”¥ PROMOTION: If they joined mid-round, they are now active players
    if (p.waiting) {
        console.log(`âœ¨ [PROMOTION] ${p.username} is now an Active Player for the new round.`);
        p.waiting = false;
    }
    
    // ğŸ›¡ï¸ FORCE READY: This ensures the autoStart loop doesn't wait for clicks
    p.ready = true; 

    // ğŸ§¹ CLEANUP: Remove hand data
    delete p.currentBet;
    delete p.cards;
    delete p.hand;
    delete p.points;      // Added: Clear points from previous round
    delete p.multiplier;  // Added: Clear multiplier from previous round
    delete p.isDo;       // Added: Clear 'Do' status
    
    p.hasDrawn = false;
    p.drawAction = null;
  });
}

function resetTableState(table) {
  table.gameInProgress = false;
  table.isProcessingResult = null; 

  // ğŸ”´ CLEAR TIMERS (using clear+null for safety)
  const timerKeys = ['countdownInterval', 'betInterval', 'watchTimer', 'findWinnerTimer', 'payoutTimer'];
  timerKeys.forEach(key => {
    if (table[key]) {
      clearInterval(table[key]);
      table[key] = null;
    }
  });

  // ğŸ” Reset variables
  table.countdown = 0;
  table.betTime = 5;
  table.dealAckReceived = false;
  table.watchTimerStarted = false;
  table.currentWinners = [];

  table.roundState.inProgress = false;
  table.roundState.startedAt = 0;
  
  // ğŸ”¥ IMPORTANT: Ensure autoStartCalled is reset for the loop
  table.autoStartCalled = false; 
}

module.exports = {
  resetPlayersForNextRound,
  resetTableState
};