const WebSocket = require("ws");

let wssRef = null;

// we inject wss later (IMPORTANT)
function initSender(wss) {
  wssRef = wss;
}

function safeWsSend(ws, payload) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return false;
  try {
    ws.send(JSON.stringify(payload));
    return true;
  } catch (error) {
    console.error("❌ safeWsSend failed", error);
    return false;
  }
}

function wsSend(ws, payload) {
  return safeWsSend(ws, payload);
}

function broadcastToTable(tableId, payload) {
  if (!wssRef) return;

  wssRef.clients.forEach(client => {
    if (
      client.tableId === tableId &&
      client.readyState === WebSocket.OPEN
    ) {
      try {
        client.send(JSON.stringify(payload));
      } catch (error) {
        console.error(`❌ broadcastToTable failed table=${tableId}`, error);
      }
    }
  });
}

module.exports = {
  initSender,
  wsSend,
  safeWsSend,
  broadcastToTable
};
